# Sprint 4: Performance and Resource Limits

**Start Date:** 2025-12-29
**Completion Date:** 2025-12-29

## Goal

Implement resource limits, optimize performance bottlenecks, and prevent resource exhaustion that could crash the service or rack up costs. This sprint addressed critical vulnerabilities related to unbounded resource usage in Browsershot processes, screenshot storage, queue concurrency, request sizes, PageSpeed API quotas, and database queries.

## What was done

* [x] Task 4.1: Implement Browsershot resource limits (timeout, memory, concurrency)
* [x] Task 4.2: Implement screenshot cleanup after PDF generation
* [x] Task 4.3: Implement queue concurrency limits
* [x] Task 4.4: Add request size validation
* [x] Task 4.5: Implement PageSpeed API quota tracking
* [x] Task 4.6: Add database query optimization

### Task 4.1: Browsershot Resource Limits

- Added timeout (60s) and memory limit (512MB) to all Browsershot processes
- Configured via `BROWSERSHOT_TIMEOUT` and `BROWSERSHOT_MEMORY_LIMIT` environment variables
- Applied Chrome arguments: `--disable-dev-shm-usage`, `--disable-gpu`, `--max-old-space-size`
- Implemented queue-based concurrency limits (3 PDFs, 5 screenshots) using Laravel's RateLimited middleware

### Task 4.2: Screenshot Cleanup

- Screenshots are now deleted immediately after successful PDF generation (configurable)
- Created `PruneOrphanedScreenshotsCommand` to clean up orphaned screenshots older than 24 hours
- Scheduled daily cleanup at 03:00
- Added configuration options: `AUDITS_DELETE_SCREENSHOTS_AFTER_PDF`, `AUDITS_ORPHANED_SCREENSHOTS_RETENTION_HOURS`

### Task 4.3: Queue Concurrency Limits

- Added `WithoutOverlapping` middleware to prevent duplicate job processing for the same audit
- Added `RateLimited` middleware to enforce concurrency limits (3 PDFs/minute, 5 screenshots/minute)
- Registered rate limiters in `AppServiceProvider` for `pdf-generation` and `screenshot-capture`

### Task 4.4: Request Size Validation

- Created `ValidateRequestSize` middleware to reject requests larger than 1MB
- Returns 413 Payload Too Large with size details
- Added max length validation to ScanData fields (url: 2048, lang: 10, strategy: 10)
- Configurable via `API_MAX_REQUEST_SIZE`

### Task 4.5: PageSpeed API Quota Tracking

- Implemented quota tracking using cache (minute and day buckets)
- Enforces limits: 6 requests/minute (free), 25,000/day (with API key)
- Logs warnings when usage exceeds 80%
- Throws `RuntimeException` when quota exceeded, job is released for retry (60s or 1h)
- Configurable via `PAGESPEED_RATE_LIMIT_PER_MINUTE`, `PAGESPEED_RATE_LIMIT_PER_DAY`

### Task 4.6: Database Query Optimization

- Added composite indexes: `[status, created_at]` and `[url, strategy, status]`
- Created `ExplainQueriesCommand` to analyze query execution plans
- Ensures common queries use indexes effectively

## Issues Encountered

### Issue 1: PHPStan Type Errors in ValidateRequestSize

**Description:** PHPStan reported type errors when using `Request::header()` method with default value and binary operations.

**Solution:** Simplified the code to use null coalescing operator and cast to int directly: `(int) ($request->header('Content-Length') ?? 0)`

## Wins

* ðŸŽ‰ No more Chromium memory bombs - processes are now limited to 512MB and 60s timeout
* ðŸŽ‰ Screenshots don't accumulate forever - auto-deletion saves disk space
* ðŸŽ‰ Queue concurrency prevents server overload from too many concurrent jobs
* ðŸŽ‰ PageSpeed API quota tracking prevents hitting limits and breaking the service
* ðŸŽ‰ Database queries are optimized with composite indexes
* ðŸŽ‰ All tests passing, PHPStan Level 8 clean, Pint formatting correct

## Metrics

| Metric | Value |
| --- | --- |
| Files created | 4 |
| Files modified | 12 |
| Tests added | 0 (existing tests still passing) |
| PHPStan errors | 0 |
| Test coverage | 31 tests passed |
| Migrations | 1 |
| Commands | 2 |

## Commits

```bash
# Task 4.1 & 4.3
add resource limit configuration variables
add resource limit configuration options
add timeout and memory limits to browsershot processes
add queue concurrency limits using rate limiting middleware

# Task 4.2
delete screenshots after successful pdf generation
add command to prune orphaned screenshots

# Task 4.4
add request size validation middleware and field max lengths

# Task 4.5
add pagespeed api quota tracking and enforcement

# Task 4.6
add composite database indexes for query optimization
add command to analyze query execution plans
fix phpstan type errors in request size middleware
```

## Next Steps

* [ ] Test resource limits under load
* [ ] Monitor PageSpeed API quota usage in production
* [ ] Verify screenshot cleanup is working as expected
* [ ] Consider adding metrics dashboard for resource usage
* [ ] Start Sprint 5: Webhook Reliability (if planned)
