# Sprint 2: Domain and Modeling

**Start Date:** 2025-12-28
**End Date:** 2025-12-28

## Objective

Create Value Objects and DTOs for type-safe handling of PageSpeed payload data, extracting only the 4 vital metrics from a 3500+ line JSON.

## Completed Tasks

- [x] Created `app/ValueObjects/Url.php`
  - URL validation via `filter_var(FILTER_VALIDATE_URL)`
  - Implements `Stringable` for easy usage
- [x] Created `app/ValueObjects/AuditScore.php`
  - Score thresholds: green (â‰¥90%), orange (50-89%), red (<50%)
  - Methods: `toPercentage()`, `getColor()`, `isPassing()`, `getLabel()`
- [x] Created `app/ValueObjects/MetricValue.php`
  - Parses display values like "0.6 s", "500 ms", "0.001"
  - Normalizes Unicode non-breaking space (U+00A0) from PageSpeed
  - Methods: `toMilliseconds()`, `toSeconds()`, `format()`
- [x] Created `app/Data/AuditData.php`
  - Spatie Laravel Data DTO with `fromPageSpeedPayload()` factory
  - Handles n8n array wrapper automatically
- [x] Created `app/Data/WebhookPayloadData.php` + `WebhookMetricsData.php`
- [x] Created unit tests: `AuditDataTest.php`, `ValueObjectsTest.php`

## Issues Encountered

### Issue 1: Flat Structure Preference
**Description:** User requested no `Domain/` folder separation - microservice is too small for DDD structure.
**Solution:** Placed Value Objects directly in `app/ValueObjects/`.

### Issue 2: Unit Test Context for `base_path()`
**Description:** `base_path()` helper not available in pure unit test context.
**Solution:** Used `dirname(__DIR__) . '/Fixtures/...'` instead.

### Issue 3: Unicode Non-Breaking Space (NBSP)
**Description:** PageSpeed JSON uses U+00A0 (`\xC2\xA0`) instead of regular space between metric value and unit (e.g., "0.6 s").
**Solution:** Added `str_replace("\xC2\xA0", ' ', $displayValue)` normalization in `MetricValue::fromDisplayValue()`.

### Issue 4: Format Threshold Logic
**Description:** Initial threshold (1000ms) caused "600 ms" output instead of "0.6 s".
**Solution:** Lowered threshold to 100ms to match PageSpeed display format.

## Victories

- ðŸŽ‰ **Critical test passes:** 3500+ line JSON parsed to exactly 4 fields successfully
- ðŸŽ‰ All 14 unit tests pass (36 assertions)
- ðŸŽ‰ PHPStan level 8: 0 errors
- ðŸŽ‰ Type-safe extraction: Score=100%, LCP="0.6 s", FCP="0.5 s", CLS="0.001"

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 8 |
| Tests created | 14 |
| Assertions | 36 |
| PHPStan errors | 0 |

## Commit

```bash
git add .
git commit -m "feat: add value objects and audit data dto"
```

## Next Steps

- [ ] Start Phase 3: Application Layer (Services, Jobs, Views)
